<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Tumor Classifier - AI-Powered MRI Analysis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>üß† Brain<br>Tumor<br>Classifier</h1>
                <p class="sidebar-subtitle">v2.0 ‚Ä¢ Medical AI</p>
            </div>
            
            <nav class="sidebar-nav">
                <button class="nav-item active" onclick="switchView('analyze')">
                    <span class="icon">üî¨</span> Analyse
                </button>
                <button class="nav-item" onclick="switchView('history')">
                    <span class="icon">üïí</span> Verlauf
                </button>
                <button class="nav-item" onclick="switchView('3d')">
                    <span class="icon">üß†</span> 3D Viewer
                </button>
                <button class="nav-item" onclick="switchView('settings')">
                    <span class="icon">‚öôÔ∏è</span> Training & Info
                </button>
            </nav>

            <div class="sidebar-footer">
                <div class="stats-mini">
                    <div class="stat-row">
                        <span>Genauigkeit:</span>
                        <span id="accuracyDisplaySidebar">0%</span>
                    </div>
                </div>
                <button class="nav-item" onclick="toggleTheme()" id="themeToggleBtn">
                    üåô Dark Mode
                </button>
                <button id="printReportBtn" class="btn btn-outline-light btn-sm w-100" onclick="window.print()">
                    üñ®Ô∏è Report
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Disclaimer Banner -->
            <div class="disclaimer-banner">
                ‚ö†Ô∏è <strong>Forschungs-Demo:</strong> Keine medizinische Diagnose. Alle Angaben ohne Gew√§hr.
            </div>

            <!-- View: Analyze -->
            <div id="view-analyze" class="view-section active">
                <div class="container">
                    <!-- Control Section -->
                    <section class="control-section">
                        <div class="stats-container" id="statsContainer">
                            <div class="stat-item">
                                <span class="stat-label">Genauigkeit</span>
                                <span class="stat-value" id="accuracyDisplay">0%</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Richtig/Gesamt</span>
                                <span class="stat-value" id="countDisplay">0 / 0</span>
                            </div>
                        </div>
                        <div class="button-group">
                            <button id="randomTestBtn" class="btn btn-primary">
                                üé≤ Random Test Image
                            </button>
                        </div>
                    </section>
            
                    <!-- Upload Section -->
                    <section class="upload-section">
                        <div id="dropzone" class="dropzone">
                            <div class="dropzone-content">
                                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                <p class="dropzone-text">Ziehe dein MRI-Bild hierher</p>
                                <p class="dropzone-subtext">oder klicke zum Ausw√§hlen</p>
                               <p class="dropzone-format">PNG, JPG ‚Ä¢ Max 16MB</p>
                            </div>
                            <input type="file" id="fileInput" accept="image/*" style="display: none;">
                        </div>
                    </section>
            
                    <!-- Results Section -->
                    <section id="results" class="results" style="display: none;">
                        <!-- Uncertainty Alert -->
                        <div id="uncertaintyAlert" class="alert alert-warning" style="display: none;">
                            ‚ö†Ô∏è <strong>Unsichere Vorhersage:</strong> Das Modell ist sich nicht sicher. Bitte manuell pr√ºfen.
                        </div>

                        <!-- Compact Grid Layout -->
                        <div class="compact-grid">
                            <!-- Left Column: Prediction & Chart -->
                            <div class="grid-left">
                                <div class="card prediction-card">
                                    <h2>üìä Klassifizierung</h2>
                                    <div id="predictionResult" class="prediction-result"></div>
                                    <canvas id="pieChart"></canvas>
                                </div>
                                
                                <!-- Multi-Model Consensus -->
                                <div class="card" id="consensusCard" style="display: none;">
                                    <h2>ü§ñ KI-Konsens</h2>
                                    <div class="consensus-header">
                                        <div class="consensus-badge" id="consensusBadge">3/3 Stimmen</div>
                                        <span id="consensusWinner" class="consensus-winner">Glioma</span>
                                    </div>
                                    <div class="model-votes" id="modelVotes">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>
                                
                                <!-- Similar Cases -->
                                <div class="card" id="similarCasesCard" style="display: none;">
                                    <h2>üîç √Ñhnliche F√§lle</h2>
                                    <p class="text-muted small mb-2">Basierend auf visueller √Ñhnlichkeit (Simuliert)</p>
                                    <div class="similar-cases-grid" id="similarCasesGrid">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>

                                <div class="card">
                                    <h2>üìà Wahrscheinlichkeiten</h2>
                                    <div id="probabilityBars" class="probability-bars"></div>
                                </div>
                            </div>
            
                            <!-- Right Column: Images & Feedback -->
                            <div class="grid-right">
                                <div class="card image-card">
                                    <div class="card-header-row">
                                        <h2>üîç KI-Analyse</h2>
                                        <div class="tooltip-container">
                                            <span class="info-icon">‚ÑπÔ∏è</span>
                                            <div class="tooltip-text">
                                                <strong>Grad-CAM Visualisierung:</strong><br>
                                                Zeigt, welche Bildbereiche f√ºr die Entscheidung des Modells am wichtigsten waren.
                                                <br><br>
                                                üî¥ Rote Bereiche = Hohe Relevanz<br>
                                                üîµ Blaue Bereiche = Niedrige Relevanz
                                            </div>
                                        </div>
                                    </div>
                                    <div id="filenameDisplay" class="filename-badge"></div>
                                    
                                    <!-- Zoom/Pan Controls -->
                                    <div class="zoom-controls">
                                        <small>Mausrad zum Zoomen ‚Ä¢ Ziehen zum Bewegen</small>
                                        <button class="btn-icon" onclick="resetZoom()">‚Ü∫ Reset</button>
                                    </div>

                                    <div class="image-comparison">
                                        <div class="image-container" id="containerOriginal">
                                            <div class="pan-zoom-wrapper" id="wrapperOriginal">
                                                <img id="originalImage" alt="Original">
                                                <!-- Bounding Box Overlay -->
                                                <svg class="bbox-overlay" id="bboxOverlayOriginal">
                                                    <rect class="bbox-rect" id="bboxRectOriginal" />
                                                    <text class="bbox-label" id="bboxLabelOriginal"></text>
                                                </svg>
                                            </div>
                                            <span class="image-label">Original</span>
                                        </div>
                                        <div class="image-container" id="containerHeatmap">
                                            <div class="pan-zoom-wrapper" id="wrapperHeatmap">
                                                <img id="heatmapImage" alt="Heatmap" class="heatmap-progressive">
                                                <!-- Bounding Box Overlay -->
                                                <svg class="bbox-overlay" id="bboxOverlayHeatmap">
                                                    <rect class="bbox-rect" id="bboxRectHeatmap" />
                                                </svg>
                                            </div>
                                            <span class="image-label">Heatmap</span>
                                            <div id="analysisProgress" class="analysis-overlay">
                                                <div class="progress-text">Analysiere...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Compact Feedback Section -->
                                <div class="card feedback-card-compact">
                                    <div class="feedback-header">
                                        <h3>Korrekt?</h3>
                                        <div id="autoAcceptTimer" class="auto-accept-timer" style="display: none;">
                                            Auto-Accept in <span id="timerSeconds">5</span>s
                                        </div>
                                    </div>
                                    <div id="feedbackButtons" class="feedback-buttons-compact">
                                        <button class="btn btn-success btn-sm" onclick="submitFeedback(true)">‚úÖ Ja</button>
                                        <button class="btn btn-danger btn-sm" onclick="showCorrectionDropdown()">‚ùå Nein</button>
                                    </div>
                                    
                                    <div id="correctionSection" class="correction-section" style="display: none;">
                                        <p>Korrekte Klasse:</p>
                                        <div class="correction-inline">
                                            <select id="correctionSelect" class="form-select">
                                                <option value="Glioma">Glioma</option>
                                                <option value="Meningioma">Meningioma</option>
                                                <option value="No Tumor">No Tumor</option>
                                                <option value="Pituitary">Pituitary</option>
                                            </select>
                                            <button class="btn btn-primary btn-sm" onclick="submitFeedback(false)">OK</button>
                                        </div>
                                    </div>
                                    <div id="feedbackThankYou" style="display: none;" class="success-message">
                                        ‚úì Feedback gespeichert
                                    </div>
                                </div>
            
                                <!-- Reload Button at Bottom -->
                                <button id="reloadRandomBtn" class="btn btn-primary btn-reload">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                                    </svg>
                                    N√§chstes Bild
                                </button>
                            </div>
                        </div>
                        
                        <div class="model-info-footer">
                            <span class="badge">Model: <span id="modelVersionDisplay">v1</span></span>
                        </div>
                    </section>
            
                    <!-- Loading Spinner -->
                    <div id="loading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>Analysiere MRI-Bild...</p>
                    </div>
            
                    <!-- Error Message -->
                    <div id="error" class="error" style="display: none;"></div>
                </div>
            </div>

            <!-- View: History -->
            <div id="view-history" class="view-section">
                <div class="container">
                    <h2>üïí Verlauf</h2>
                    <div id="historyList" class="history-list">
                        <p class="text-muted">Noch keine Analysen in dieser Sitzung.</p>
                    </div>
                </div>
            </div>

            <!-- View: 3D Viewer -->
            <div id="view-3d" class="view-section">
                <div class="container">
                    <h2>üß† 3D Slice Viewer</h2>
                    <div class="card">
                        <div class="viewer-3d-container">
                            <canvas id="sliceCanvas" width="300" height="300"></canvas>
                            <div class="slice-controls">
                                <label>Slice Position: <span id="sliceValue">15</span>/30</label>
                                <input type="range" id="sliceSlider" min="1" max="30" value="15" class="slider">
                            </div>
                            <p class="text-muted small mt-2 text-center">Simulierte 3D-Ansicht (Axial)</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Settings -->
            <div id="view-settings" class="view-section">
                <div class="container">
                    <h2>‚öôÔ∏è Einstellungen & Training</h2>
                    
                    <div class="card mb-4">
                        <h3>Active Learning</h3>
                        <p>Trainiere das Modell mit deinem gesammelten Feedback nach.</p>
                        
                        <div id="trainingProgressContainer" style="display: none; margin-top: 1rem;">
                            <div class="progress-wrapper">
                                <div id="trainingProgressBar" class="progress-bar" style="width: 0%"></div>
                            </div>
                            <p id="trainingStatusText" class="text-muted small mt-2">Initialisiere...</p>
                        </div>

                        <div class="alert alert-info" id="trainingAlert">
                            <strong>Status:</strong> <span id="trainingStatus">Bereit</span>
                        </div>
                        <button id="startTrainingBtn" class="btn btn-primary" onclick="startTraining()">
                            üöÄ Modell nachtrainieren (Simulation)
                        </button>
                    </div>

                    <div class="card">
                        <h3>√úber</h3>
                        <p>Brain Tumor Classifier v2.0</p>
                        <p>Entwickelt f√ºr Forschungszwecke.</p>
                        <p>Device: <span id="deviceInfo">Loading...</span></p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
